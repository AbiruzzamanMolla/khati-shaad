@extends('seller.layouts.master')

@section('title')
    <title>{{ __('Edit Product Variant') }}</title>
@endsection

@section('seller-content')
    <div class="main-content">
        <section class="section">
            <x-admin.breadcrumb title="{{ __('Edit Product Variant') }}" :list="[
                __('Dashboard') => route('seller.dashboard'),
                __('Product List') => route('seller.product.index'),
                __('Product Variant List') => route('seller.product.product-variant', $product->id),
                __('Edit Product Variant') => '#',
            ]" />

            <div class="section-body">
                <div class="mt-4 row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between">
                                <h4>{{ __('Edit Product Variation') }}</h4>
                                <div>
                                    <a class="btn btn-primary"
                                        href="{{ route('seller.product.product-variant', $product->id) }}"><i
                                            class="fa fa-arrow-left"></i> {{ __('Back') }}</a>
                                </div>
                            </div>
                            <div class="card-body">
                                <form action="{{ route('seller.product.product-variant.update', $variant->id) }}"
                                    method="post">
                                    @csrf
                                    @method('PUT')
                                    <div class="row">
                                        <div class="col-md-12 row">
                                            <div class="col-md-12">
                                                <div class="attributes_variations row" style="padding: 0 15px;">
                                                    <table class="table">
                                                        <thead>
                                                            <tr>
                                                                <th>{{ __('Price') }}</th>
                                                                <th>{{ __('Offer Price Type') }}</th>
                                                                <th>{{ __('Offer Price') }}</th>
                                                                <th>{{ __('Offer Validity') }}</th>
                                                                <th>{{ __('Is Default') }}</th>
                                                                <th>{{ __('Stock') }}/{{ optional($product->unit)->name ?: __('Unit') }}
                                                                </th>
                                                                </th>
                                                                <th>{{ __('SKU') }}</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td>
                                                                    <div
                                                                        class="d-flex justify-content-between align-items-center my-3">
                                                                        <input class="form-control selling-price"
                                                                            name="selling_price" type="text"
                                                                            value="{{ $variant->price }}"
                                                                            placeholder="{{ __('Enter Price') }}">
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <div
                                                                        class="d-flex justify-content-between align-items-center my-3">
                                                                        <select class="form-select offer-type"
                                                                            name="offer_price_type">
                                                                            <option value="">
                                                                                {{ __('Select Offer Price Type') }}
                                                                            </option>
                                                                            <option value="fixed"
                                                                                @selected($variant->offer_price_type == 'fixed')>
                                                                                {{ __('Fixed') }}</option>
                                                                            <option value="percentage"
                                                                                @selected($variant->offer_price_type == 'percentage')>
                                                                                {{ __('Percentage') }}</option>
                                                                        </select>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <div
                                                                        class="d-flex justify-content-between align-items-center my-3">
                                                                        <input class="form-control offer-price"
                                                                            name="offer_price" type="text"
                                                                            value="{{ $variant->offer_price }}"
                                                                            placeholder="{{ $variant->offer_price_type == 'fixed' ? __('Enter Offer Price') : __('Enter Offer Price Percentage') }}">
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    @php
                                                                        $offerValidity =
                                                                            $variant->offer_price_start !== null ||
                                                                            $variant->offer_price_end !== null;
                                                                    @endphp

                                                                    <div
                                                                        class="d-flex justify-content-between align-items-center my-3">
                                                                        <input class="form-check offer-validity"
                                                                            type="checkbox" value="1"
                                                                            @checked($offerValidity)>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <div
                                                                        class="d-flex justify-content-between align-items-center my-3">
                                                                        <input name="is_default" type="hidden"
                                                                            value="0">
                                                                        <input class="form-check" name="is_default"
                                                                            type="checkbox" value="1"
                                                                            @checked($variant->is_default)>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <div
                                                                        class="d-flex justify-content-between align-items-center my-3">
                                                                        <input class="form-control stock_qty"
                                                                            name="stock_qty" type="number"
                                                                            value="{{ $variant->stock_qty }}"
                                                                            placeholder="{{ __('Enter Stock Qty') }}">
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <div
                                                                        class="d-flex justify-content-between align-items-center my-3">
                                                                        <input class="form-control sku" name="sku"
                                                                            type="text" value="{{ $variant->sku }}"
                                                                            placeholder="{{ __('Enter SKU') }}">
                                                                    </div>
                                                                </td>
                                                            </tr>

                                                            <tr
                                                                class="offer-validity-date {{ $offerValidity ? '' : 'd-none' }}">
                                                                <td colspan="7">
                                                                    <div
                                                                        class="d-flex justify-content-between align-items-center my-3">
                                                                        <input
                                                                            class="form-control datepicker offer-price-start"
                                                                            name="offer_price_start" type="text"
                                                                            value="{{ old('offer_price_start', $variant->offer_price_start) }}"
                                                                            placeholder="{{ __('Offer Price Start Date') }}">
                                                                        <span class="mx-2">{{ __('to') }}</span>
                                                                        <input
                                                                            class="form-control datepicker offer-price-end ms-2"
                                                                            name="offer_price_end" type="text"
                                                                            value="{{ old('offer_price_end', $variant->offer_price_end) }}"
                                                                            placeholder="{{ __('Offer Price End Date') }}">
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="text-center offset-md-2 col-md-8">
                                            <x-admin.update-button :text="__('Update')">
                                            </x-admin.update-button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    @include('components.admin.preloader')
@endsection

@push('js')
    <script>
        (function($) {
            "use strict";
            $(document).ready(function() {
                $('[name="attribute"]').on('change', function() {

                    var attribute = $(this).val();
                    if (attribute) {
                        $('.preloader_area').removeClass('d-none');
                        $.ajax({
                            url: "{{ route('seller.attribute.get.value') }}",
                            type: 'POST',
                            data: {
                                _token: "{{ csrf_token() }}",
                                attribute: attribute,
                                product_id: "{{ $product->id }}"
                            },
                            success: function(response) {
                                $('.attributes_values').html('');
                                $.each(response.data, function(index, attribute) {
                                    let html = `
                                    <div class="col-4 mb-2">
                                        <input type="text" name='choice[]' value="${attribute.name}" class="form-control" readonly>
                                    </div>
                                    <div class="col-8 mb-2">
                                        <select name="choice_options_${attribute.id}[]" class="form-control select2 attr-multi-value" multiple>
                                `;
                                    $.each(attribute.values, function(index,
                                        value) {
                                        html +=
                                            `<option value="${value.name}">${value.name}</option>`;
                                    });

                                    html += `
                                        </select>
                                    </div>
                                `;

                                    // Append the generated HTML to a container
                                    $('.attributes_values').append(html);
                                    $('.attributes_variations').html('');
                                });

                                // After appending all select elements, initialize Select2
                                $('.select2').select2();
                                $('.preloader_area').addClass('d-none')
                            },
                            error: function(xhr, ajaxOptions, thrownError) {
                                console.log(xhr);
                                $('.preloader_area').addClass('d-none')
                            }
                        });

                    }

                })
                $(document).on('change', '.attr-multi-value', function() {
                    // Initialize an empty array to store selected values
                    var selectedValues = [];

                    // Loop through each select element
                    $('.attr-multi-value').each(function(index, select) {
                        // Get the selected options for the current select element
                        var selectedOptions = $(select).val();

                        // If options are selected, add them to the selectedValues array
                        if (selectedOptions && selectedOptions.length > 0) {
                            selectedValues.push(selectedOptions);
                        }
                    });

                    if (selectedValues.length == 0) {
                        $('.attributes_variations').html('');
                        return;
                    }
                    // Create a variation table HTML
                    var variationTableHTML =
                        '<table class="table"><thead><tr><th>Variant</th><th>Selling Price</th><th>Cost</th><th>SKU</th></tr></thead><tbody>';
                    // Generate rows for each combination of selected values
                    selectedValues = cartesian(selectedValues);
                    $.each(selectedValues, function(index, combination) {
                        // Create a row for the combination
                        variationTableHTML += '<tr>';
                        variationTableHTML += '<td>' + combination.join('-') +
                            `<input type="hidden" name="variant[]" value="${combination.join('-')}">` +
                            '</td>'; // Variant column (joined if there are multiple)
                        variationTableHTML +=
                            `<td >
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <input type="text" class="form-control selling-price w-75" name="price[]" placeholder="Enter Selling Price">
                            </div>
                        </td>
                        <td >
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <input type="text" class="form-control buying-price w-75" name="cost[]" placeholder="Enter Buying Price" value="{{ $product->cost }}">
                            </div>
                        </td>
                    `;
                        const sku = "{{ $product->sku }}";
                        // Selling Price column with input
                        variationTableHTML +=
                            `<td><input type="text" class="form-control sku" name="sku[]" placeholder="Enter SKU" value="${combination.join('-').toUpperCase()}-${sku.toUpperCase()}"></td>`; // SKU column with input
                        variationTableHTML += '</tr>';
                    });

                    variationTableHTML += '</tbody></table>';

                    // Append the variation table HTML to a container
                    $('.attributes_variations').html(variationTableHTML);
                });
                // reset table if no attribute selected
                $(document).on('change', '#attribute', function() {
                    if ($(this).val() == '') {
                        $('.attributes_variations').html('');
                        $('.attributes_values').html('');
                    }
                });

                // offer-validity checkbox d none offer-validity-date
                $(document).on('change', '.offer-validity', function() {
                    if ($(this).is(':checked')) {
                        $('.offer-validity-date').removeClass('d-none');
                    } else {
                        $('.offer-validity-date').addClass('d-none');
                    }
                });
            });

            function cartesian(arrays) {
                var result = [];
                var max = arrays.length - 1;

                function helper(arr, i) {
                    for (var j = 0, l = arrays[i].length; j < l; j++) {
                        var a = arr.slice(0); // clone arr
                        a.push(arrays[i][j]);
                        if (i == max)
                            result.push(a);
                        else
                            helper(a, i + 1);
                    }
                }
                helper([], 0);
                return result;
            }

        })(jQuery);
    </script>
@endpush
